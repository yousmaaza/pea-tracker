#!/bin/bash

# Script d'installation de pip-mode dans le profil shell
# Usage: ./scripts/install-pip-mode.sh

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
PIP_MODE_SCRIPT="$PROJECT_ROOT/scripts/pip-mode.sh"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“¦ Installation de pip-mode"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# DÃ©tecter le shell
if [ -n "$ZSH_VERSION" ]; then
    SHELL_NAME="zsh"
    PROFILE_FILE="$HOME/.zshrc"
elif [ -n "$BASH_VERSION" ]; then
    SHELL_NAME="bash"
    PROFILE_FILE="$HOME/.bashrc"
else
    echo "âš ï¸  Shell non reconnu. Installation manuelle requise."
    exit 1
fi

echo "Shell dÃ©tectÃ©: $SHELL_NAME"
echo "Fichier de profil: $PROFILE_FILE"
echo ""

# VÃ©rifier que le script pip-mode existe
if [ ! -f "$PIP_MODE_SCRIPT" ]; then
    echo "âŒ Erreur: $PIP_MODE_SCRIPT non trouvÃ©"
    exit 1
fi

# VÃ©rifier si pip-mode est dÃ©jÃ  installÃ©
if grep -q "pip-mode.sh" "$PROFILE_FILE" 2>/dev/null; then
    echo "âœ“ pip-mode est dÃ©jÃ  configurÃ© dans $PROFILE_FILE"
    echo ""
    read -p "Voulez-vous rÃ©installer ? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Installation annulÃ©e."
        exit 0
    fi

    # Supprimer l'ancienne configuration
    echo "Suppression de l'ancienne configuration..."
    sed -i.bak '/# pip-mode configuration/,/# End pip-mode configuration/d' "$PROFILE_FILE"
fi

# Ajouter la configuration
echo "Ajout de pip-mode Ã  $PROFILE_FILE..."
cat >> "$PROFILE_FILE" << EOF

# pip-mode configuration
# Auto-generated by $0 on $(date)
if [ -f "$PIP_MODE_SCRIPT" ]; then
    source "$PIP_MODE_SCRIPT"
    alias pip-mode='pip_mode'
fi
# End pip-mode configuration
EOF

echo "âœ“ Configuration ajoutÃ©e avec succÃ¨s"
echo ""

# Test de la configuration
echo "Test de l'installation..."
if source "$PROFILE_FILE" && type pip_mode &>/dev/null; then
    echo "âœ“ pip-mode installÃ© avec succÃ¨s !"
    echo ""
    echo "Pour utiliser pip-mode :"
    echo "  1. Recharger votre shell : source $PROFILE_FILE"
    echo "  2. Utiliser la commande : pip-mode status"
    echo ""
else
    echo "âš ï¸  Installation rÃ©ussie mais test Ã©chouÃ©"
    echo "   Rechargez manuellement : source $PROFILE_FILE"
    echo ""
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Commandes disponibles :"
echo "  pip-mode status   - VÃ©rifier la configuration"
echo "  pip-mode nexus    - Basculer vers Nexus"
echo "  pip-mode standard - Basculer vers PyPI"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Documentation : $PROJECT_ROOT/docs/pip-mode-guide.md"
